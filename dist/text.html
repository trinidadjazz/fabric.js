<html>
<style>
    .canvas-container {
        border: 1px solid gray;
    }
</style>
<script src="fabric.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.7.0/fabric.min.js"></script> -->
<canvas width="600" height="300"></canvas>
<script>
    const canvas = new fabric.Canvas(document.querySelector('canvas'));

    // Define `LimitedTextbox` class which extends `Textbox`
    const LimitedTextbox = fabric.util.createClass(fabric.Textbox, {
        insertChars: function (text) {
            console.log('here -insertchars');
        },

        onKeyDown: function (e) {
            // this.onEnter = false;
            if (e.key == "Enter") {
                this.onEnter = true;
            }
            this.keyCode = e.keyCode;

            // Call parent class method
            this.callSuper('onKeyDown', e);
        },

        // Override `insertChars` method
        onInput: function (e) {

            if (this.maxWidth) {
                if (this.keyCode > 64 || this.keyCode == 32) {
                    var lineIndex = this.get2DCursorLocation().lineIndex;
                    const textWidthUnderCursor = this.getLineWidth(lineIndex);
                    var char_width = this._measureWord(e.data, lineIndex);
                    const newLinesLength = this._wrapText(this.textLines, this.maxWidth).length;
                    if (textWidthUnderCursor + char_width > this.maxWidth) {
                        if(newLinesLength == this.maxLines) {
                            this.hiddenTextarea.value = this.text;
                            return;
                        }
                        this.text += '\n';
                        this.textLines[lineIndex] += '\n';
                        this.hiddenTextarea.value = this.text;
                        // console.log(this.textLines);
                        // if(this.fontSizeDelta && this.fontSizeDelta > 0) {
                        //     if (this.cacheWidth > this.maxWidth) {
                        //         this.fontSize -= 1;
                        //     }
                        // }
                        // return;
                    }
                    if(newLinesLength > this.maxLines) {
                        this.hiddenTextarea.value = this.text;
                        return;
                    }
                }
            }
            // Call parent class method
            this.callSuper('onInput', e);
        }

    });
    // Create limited text box with max width 300px and max 2 lines
    canvas.add(
        new LimitedTextbox('text', {
            top: 10,
            left: 10,
            width: 300,
            maxWidth: 300,
            maxLines: 2,
            fontSizeDelta: 1.5
        })
    );

    canvas.renderAll();
</script>

</html>