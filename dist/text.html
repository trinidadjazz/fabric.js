<html>
<style>
.canvas-container {
  border: 1px solid gray;
}
</style>
<script src="fabric.js"></script>

<canvas width="600" height="300"></canvas>
<script>
const canvas = new fabric.Canvas(document.querySelector('canvas'));

// Define `LimitedTextbox` class which extends `Textbox`
const LimitedTextbox = fabric.util.createClass(fabric.Textbox, {
    insertChars: function(text) {
        console.log('here -insertchars');
    },

    onKeyDown: function(e) {

        if(e.key == "Enter") {
            this.onEnter = true;
        }
        this.keyCode = e.keyCode;


        if (this.maxWidth && this.onEnter!=true) {
            if(this.keyCode > 64) {
                const textWidthUnderCursor = this.getLineWidth(this.get2DCursorLocation().lineIndex);
                var char_width = this._measureWord(e.key, this.get2DCursorLocation().lineIndex);
                if (textWidthUnderCursor + char_width > this.maxWidth) {
                    return;
                }
                const newLinesLength = this._wrapText(this.textLines, this.maxWidth).length;
                if(newLinesLength > this.maxLines) {
                    return;
                }   
            }
        }

        if (this.maxLines && this.onEnter == true) {
            const newLinesLength = this._wrapText(this.textLines, this.maxWidth).length;
            if(newLinesLength >= this.maxLines) {
                return;
            }
        }
        // Call parent class method
        this.callSuper('onKeyDown', e);
    },
    onKeyUp: function(e) {
        
        if (this.maxWidth && this.onEnter!=true) {
            if(this.keyCode > 64) {
                const textWidthUnderCursor = this.getLineWidth(this.get2DCursorLocation().lineIndex);
                var char_width = this._measureWord(e.key, this.get2DCursorLocation().lineIndex);
                if (textWidthUnderCursor + char_width > this.maxWidth) {
                    return;
                }
                const newLinesLength = this._wrapText(this.textLines, this.maxWidth).length;
                if(newLinesLength > this.maxLines) {
                    return;
                }   
            }
        }

        if (this.maxLines && this.onEnter == true) {
            const newLinesLength = this._wrapText(this.textLines, this.maxWidth).length;
            if(newLinesLength >= this.maxLines) {
                return;
            }
        }
        
        // Call parent class method
        this.callSuper('onKeyUp', e);
    },

    // Override `insertChars` method
    onInput: function(e) {
        console.log(this);
        if (this.maxWidth && this.onEnter!=true) {
            console.log(this.keyCode);
            if(this.keyCode > 64) {
                const textWidthUnderCursor = this.getLineWidth(this.get2DCursorLocation().lineIndex);
                var char_width = this._measureWord(e.data, this.get2DCursorLocation().lineIndex);
                if (textWidthUnderCursor + char_width > this.maxWidth) {
                    this.hiddenTextarea.value = this.text;
                    return;
                }
                const newLinesLength = this._wrapText(this.textLines, this.maxWidth).length;
                if(newLinesLength > this.maxLines) {
                    this.hiddenTextarea.value = this.text;
                    return;
                }   
            }
        }
        if (this.maxLines && this.onEnter == true) {
            const newLinesLength = this._wrapText(this.textLines, this.maxWidth).length;
            if(newLinesLength >= this.maxLines) {
                this.onEnter = false;
                this.hiddenTextarea.value = this.text;
                return;
            }
        }
        this.onEnter == false;
        // Call parent class method
        this.callSuper('onInput', e);
    }

});

// Create limited text box with max width 300px and max 2 lines
canvas.add(
  new LimitedTextbox('text', {
    top: 10,
    left: 10,
    width: 300,
    maxWidth: 300,
    maxLines: 2
  })
);

canvas.renderAll();
</script>
</html>